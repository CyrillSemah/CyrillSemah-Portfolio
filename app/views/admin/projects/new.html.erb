<div class="admin-experience-container">
  <div class="container">
    <!-- Menu de navigation admin -->
    <%= render 'admin/shared/admin_nav' %>
    
    <div class="content-section">
      <div class="content-header">
        <div>
          <h2>
          <% if @project.development? %>
            Nouveau projet de développement
          <% else %>
            Nouveau projet de retouche & création
          <% end %>
        </h2>
        <p class="subtitle">
          <% if @project.development? %>
            Renseignez les détails de votre nouveau projet de développement
          <% else %>
            Renseignez les détails de votre nouveau projet de retouche & création
          <% end %>
        </p>
        </div>
        <div class="header-actions">
          <%= link_to admin_projects_path, class: "animated-action-button" do %>
            <div class="icon-container">
              <i class="fas fa-arrow-left"></i>
            </div>
            <span class="button-text">Retour à la liste</span>
          <% end %>
        </div>
      </div>
  
      <div class="form-content" data-controller="project-form">
        <%= form_with(model: [:admin, @project], local: true, html: { class: 'form', multipart: true }) do |form| %>
          <% if @project.errors.any? %>
            <div class="alert alert-danger">
              <h2><%= pluralize(@project.errors.count, "erreur") %> :</h2>
              <ul>
                <% @project.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <%= form.hidden_field :project_type %>

          <!-- Bloc pour les champs communs -->
          <div class="experience-list__group mb-4">
            <div class="experience-list__group-header">
              <h3 class="mb-0">Informations générales du projet</h3>
            </div>
            <div class="experience-list__group-items">
              <div class="experience-list__item">
                <div class="experience-list__item-body">
                  <!-- Champs communs aux deux types de projets -->
                  <div class="form-group">
                    <%= form.label :title, "Titre" %>
                    <%= form.text_field :title, class: 'form-control' %>
                  </div>
                  
                  <div class="form-group">
                    <%= form.label :technologies, "Technologies (séparées par des virgules)" %>
                    <%= form.text_field :technologies, class: 'form-control', placeholder: "Ruby on Rails, JavaScript, PostgreSQL, Photoshop, Illustrator, InDesign" %>
                  </div>
                  
                  <div class="form-group">
                    <%= form.label :description, "Description" %>
                    <%= form.text_area :description, class: 'form-control', rows: 6 %>
                  </div>
                  
                  <div class="form-group">
                    <%= form.label :position, "Position" %>
                    <%= form.number_field :position, class: 'form-control' %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Champs spécifiques au type Développement -->
          <% if @project.development? %>
            <div class="experience-list__group mb-4">
              <div class="experience-list__group-header">
                <h3 class="mb-0">Informations spécifiques au projet de développement</h3>
              </div>
              <div class="experience-list__group-items">
                <div class="experience-list__item">
                  <div class="experience-list__item-body">
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <%= form.label :github_url, "URL GitHub (optionnel)" %>
                        <%= form.url_field :github_url, class: 'form-control', placeholder: "https://github.com/username/project" %>
                      </div>
                      
                      <div class="form-group col-md-6">
                        <%= form.label :live_url, "URL Démo (optionnel)" %>
                        <%= form.url_field :live_url, class: 'form-control', placeholder: "https://example.com" %>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <%= form.label :image, "Image principale du projet" %>
                      <%= form.file_field :image, class: 'form-control-file', direct_upload: true %>
                    </div>
                    
                    <div class="form-group">
                      <%= form.label :development_images, "Images additionnelles (carrousel)" %>
                      <%= form.file_field :development_images, multiple: true, class: 'form-control-file', direct_upload: true %>
                      <small class="form-text text-muted">Vous pouvez sélectionner plusieurs images pour le carrousel</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
          
          <!-- Champs spécifiques au type Retouche & Création -->
          <% if @project.retouche_creation? %>
            <div class="experience-list__group mb-4">
              <div class="experience-list__group-header">
                <h3 class="mb-0">Informations spécifiques au projet de retouche & création</h3>
              </div>
              <div class="experience-list__group-items">
                <div class="experience-list__item">
                  <div class="experience-list__item-body">
                    <%= form.fields_for :project_visuals do |visual_form| %>
                      <div class="visual-form-container mb-4 p-3 border rounded" id="visual-form-container">
                        <%= visual_form.hidden_field :position, value: 0 %>
                        
                        <div class="form-group">
                          <%= visual_form.label :professional_experience_id, "Entreprise" %>
                          <%= visual_form.select :professional_experience_id, 
                              options_for_select(@companies.map { |c| [c.company_name, c.id] } + [["Autre", "Autre"]]), 
                              { include_blank: "Sélectionnez une entreprise" }, 
                              { class: 'form-control', id: 'company-selector' } %>
                          
                          <!-- Prévisualisation du logo de l'entreprise sélectionnée -->
                          <div class="company-logo-preview mt-3" data-company-selector-target="logoPreview" style="display: none;"></div>
                        </div>
                        
                        <div class="other-company-fields" style="display: none;" id="other-company-fields">
                          <div class="form-group">
                            <%= visual_form.label :company_name, "Nom de l'entreprise" %>
                            <%= visual_form.text_field :company_name, class: 'form-control', placeholder: "Nom de l'entreprise", data: { "company-selector-target": "companyNameField" } %>
                          </div>
                          
                          <div class="form-group">
                            <%= visual_form.label :company_logo, "Logo de l'entreprise" %>
                            <%= visual_form.file_field :company_logo, class: 'form-control-file', direct_upload: true, data: { "company-selector-target": "companyLogoField" } %>
                            <% if visual_form.object.company_logo.attached? %>
                              <div class="current-image mt-2">
                                <% if visual_form.object.company_logo.content_type == 'image/svg+xml' %>
                                  <%= image_tag visual_form.object.company_logo, style: 'max-width: 150px; max-height: 100px;', alt: "Logo entreprise" %>
                                <% else %>
                                  <%= image_tag visual_form.object.company_logo.variant(resize_to_limit: [150, 100]), alt: "Logo entreprise" %>
                                <% end %>
                                <p class="text-muted small">Format: <%= visual_form.object.company_logo.filename %></p>
                              </div>
                            <% end %>
                          </div>
                        </div>
                        
                        <div class="form-group">
                          <%= visual_form.label :description, "Description" %>
                          <%= visual_form.text_area :description, class: 'form-control', rows: 3 %>
                        </div>
                        
                        <div class="form-row">
                          <div class="form-group col-md-6">
                            <%= visual_form.label :visual_type, "Type de visuel" %>
                            <%= visual_form.select :visual_type, ProjectVisual.visual_types.keys.map { |k| [k.humanize, k] }, {}, class: 'form-control', data: { action: "change->project-form#toggleVisualType", "project-form-target": "visualType" } %>
                          </div>
                          
                          <div class="form-group col-md-6">
                            <%= visual_form.label :display_type, "Méthode d'affichage" %>
                            <%= visual_form.select :display_type, ProjectVisual.display_types.keys.map { |k| [k.humanize, k] }, {}, class: 'form-control', data: { "project-form-target": "displayType" } %>
                          </div>
                        </div>
                        
                        <div class="visual-images" data-project-form-target="visualImages">
                          <div class="form-row">
                            <div class="form-group col-md-6 before-image-group" data-project-form-target="beforeImageGroup">
                              <%= visual_form.label :before_image, "Image avant" %>
                              <%= visual_form.file_field :before_image, class: 'form-control-file', direct_upload: true %>
                            </div>
                            
                            <div class="form-group col-md-6 after-image-group" data-project-form-target="afterImageGroup">
                              <%= visual_form.label :after_image, "Image après" %>
                              <%= visual_form.file_field :after_image, class: 'form-control-file', direct_upload: true %>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
          
          <div class="experience-list__item-actions">
            <%= link_to "Annuler", admin_projects_path, class: "btn btn-view" %>
            <%= form.submit "Créer le projet", class: "btn btn-edit" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sélectionner les éléments nécessaires
    const companySelector = document.getElementById('company-selector');
    const otherCompanyFields = document.getElementById('other-company-fields');
    
    if (companySelector && otherCompanyFields) {
      // Fonction pour gérer l'affichage des champs conditionnels
      function toggleOtherCompanyFields() {
        console.log('Valeur sélectionnée:', companySelector.value);
        
        if (companySelector.value === 'Autre') {
          otherCompanyFields.style.display = 'block';
          console.log('Affichage des champs conditionnels');
        } else {
          otherCompanyFields.style.display = 'none';
          console.log('Masquage des champs conditionnels');
        }
      }
      
      // Appliquer l'état initial
      toggleOtherCompanyFields();
      
      // Ajouter un écouteur d'événement pour le changement de sélection
      companySelector.addEventListener('change', toggleOtherCompanyFields);
      console.log('Écouteur d\'événement ajouté au sélecteur d\'entreprise');
    } else {
      console.error('Éléments DOM non trouvés');
    }
  });
</script>

<% content_for :styles do %>
  <style>
    .card-header {
      border-radius: 0.25rem 0.25rem 0 0;
    }
    
    .form-actions {
      margin-top: 2rem;
    }
  </style>
<% end %>

<% content_for :scripts do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialisation du contrôleur Stimulus pour le formulaire de projet
      // (sera implémenté plus tard)
    });
  </script>
<% end %>
